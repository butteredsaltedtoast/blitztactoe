<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlitzTacToe - Game</title>
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwIiB4Mj0iMSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNmZjk1MDAiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjZmY0NDQ0Ii8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByeD0iMTIiIGZpbGw9IiMwYTAwMTUiIC8+CiAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg4LDgpIj4KICAgIDxjaXJjbGUgY3g9IjI0IiBjeT0iMjQiIHI9IjIwIiBmaWxsPSJ1cmwoI2cpIiBvcGFjaXR5PSIwLjk4IiAvPgogICAgPHRleHQgeD0iMjQiIHk9IjMwIiBmb250LWZhbWlseT0iQ291cmllciBOZXcsIG1vbm9zcGFjZSIgZm9udC1zaXplPSIyMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzBhMDAxNSIgZm9udC13ZWlnaHQ9IjcwMCI+WDwvdGV4dD4KICA8L2c+Cjwvc3ZnPgo=" type="image/svg+xml">
    <link rel="shortcut icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwIiB4Mj0iMSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNmZjk1MDAiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjZmY0NDQ0Ii8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByeD0iMTIiIGZpbGw9IiMwYTAwMTUiIC8+CiAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg4LDgpIj4KICAgIDxjaXJjbGUgY3g9IjI0IiBjeT0iMjQiIHI9IjIwIiBmaWxsPSJ1cmwoI2cpIiBvcGFjaXR5PSIwLjk4IiAvPgogICAgPHRleHQgeD0iMjQiIHk9IjMwIiBmb250LWZhbWlseT0iQ291cmllciBOZXcsIG1vbm9zcGFjZSIgZm9udC1zaXplPSIyMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzBhMDAxNSIgZm9udC13ZWlnaHQ9IjcwMCI+WDwvdGV4dD4KICA8L2c+Cjwvc3ZnPgo=" />
    <style>
        .hidden { display: none !important; }
        
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #000000 0%, #0a0015 50%, #000000 100%);
            background-attachment: fixed;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .container { 
            text-align: center; 
            padding: 20px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            max-width: 480px;
            width: 100%;
            box-sizing: border-box;
        }

        .container h1 {
            font-weight: 200;
            letter-spacing: 6px;
            background: linear-gradient(90deg, #ff9500, #ff4444, #45b6fe);
            font-family: 'Courier New', monospace;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }

                #game-over-actions {
                    animation: fadeIn 0.5s ease;
                }
        @keyframes slideOffLeft {
          0% {
            transform: translateX(0) rotate(0deg);
            opacity: 1;
          }
          100% {
            transform: translateX(-120vw) rotate(-20deg);
            opacity: 0;
          }
        }

        @keyframes slideInRight {
          0% {
            transform: translateX(120vw) rotate(20deg);
            opacity: 0;
          }
          100% {
            transform: translateX(0) rotate(0deg);
            opacity: 1;
          }
        }
        
        .board {
            display: grid;
            grid-template-columns: repeat(3, 80px);
            grid-template-rows: repeat(3, 80px);
            gap: 4px;
            margin: 20px auto;
        }

        .board.active {
          animation: fadeIn 0.3s ease;
        }

        .board.slide-off {
          animation: slideOffLeft 0.4s ease forwards;
        }

        .board.slide-in {
          animation: slideInRight 0.4s ease;
        }

        @keyframes pop {
          0% { transform: scale(0.8); opacity: 0; }
          50% { transform: scale(1.1); }
          100% { transform: scale(1); opacity: 1; }
        }
        
        .cell {
            border: 1px solid #333;
            font-size: 2rem;
            backdrop-filter: blur(2px);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(17, 17, 17, 0.7);
            transition: all 0.2s;
        }
        
        .cell[data-symbol="x"]{
            color: #ff4444;
            text-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
            animation: pop 0.2s ease;
        }

        .cell[data-symbol="o"] {
            color: #45b6fe;
            text-shadow: 0 0 15px rgba(20, 20, 255, 0.6);
            animation: pop 0.2s ease;
        }

        .cell:hover {
            background: #222;
            border-color: #555;
            transform: scale(1.05);
        }

        .cell:active {
            transform: scale(0.95);
        }
        
        .info { display: flex; justify-content: center; gap: 20px; margin: 10px 0; }

        .info > div {
            padding: 12px 24px;
            border: 1px solid #333;
            background: rgba(10, 10, 10, 0.8);
            border-radius: 4px;
        }

        @keyframes urgentPulse {
          0%, 100% { opacity: 1;}
          50% { opacity: 0.5; }
        }

        #timer[data-remaining="3"] {
            color: #ffaa00;
        }

        #timer[data-remaining="2"], #timer[data-remaining="1"] {
            color: #ff4444;
            animation: urgentPulse 0.5s infinite;
        }

        @keyframes winglow {
          from { box-shadow: 0 0 10px rgba(0, 255, 100, 0.3); }
          to { box-shadow: 0 0 25px rgba(0, 255, 100, 0.1); }
        }

        @keyframes loseglow {
          from { box-shadow: 0 0 10px rgba(255, 68, 68, 0.3); }
          to { box-shadow: 0 0 25px rgba(255, 68, 68, 0.6); }
        }

        .cell[data-winning="true"][data-result="win"] {
          background: rgba(0, 255, 100, 0.1);
          border-color: #00ff64;
          animation: winglow 1s ease infinite alternate;
        }

        .cell[data-winning="true"][data-result="lose"] {
          background: rgba(255, 68, 68, 0.1);
          border-color: #ff4444;
          animation: loseglow 1s ease infinite alternate;
        }

        #status.win {
            color: #00ff64;
            text-shadow: 0 0 20px rgba(0, 255, 100, 0.5);
        }

        #status.lose {
            color: #ff4444;
            text-shadow: 0 0 20px rgba(255, 64, 64, 0.5)
        }

        #status.draw {
            color: #888;
            text-shadow: 0 0 20px rgba(124, 124, 124, 0.5);
        }

        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          20% { transform: translateX(-10px); }
          40% { transform: translateX(10px); }
          60% { transform: translateX(-10px); }
          80% { transform: translateX(10px); }
        }

        @keyframes slideUp {
          from {
            opacity: 0;
            transform: translateX(-50%) translateY(20px);
          }

          to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
          }
        }

        #toast {
          position: fixed;
          bottom: 30px;
          left: 50%;
          transform: translateX(-50%);
          background: #222;
          border: 1px solid #444;
          padding: 12px 24px;
          animation: slideUp 0.3s ease;
        }

        #game-over-actions {
          display: flex;
          gap: 15px;
          justify-content: center;
          margin-top: 30px;
          flex-wrap: wrap;
        }

        #rematch-btn {
          padding: 12px 32px;
          font-size: 1.1rem;
          font-weight: 600;
          border: 2px solid #ffaa00;
          background: linear-gradient(135deg, rgba(255, 166, 0, 0.1), rgba(255, 174, 0, 0.05));
          color: #ffffff;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.3s ease;
          text-transform: uppercase;
          letter-spacing: 1px;
          box-shadow: 0 0 15px rgba(236, 155, 4, 0.2);
          position: relative;
          overflow: hidden;
        }

        #rematch-btn:hover:not(:disabled) {
          background: linear-gradient(135deg, rgba(255, 187, 0, 0.2), rgba(0, 255, 100, 0.1));
          box-shadow: 0 0 25px rgba(255, 196, 0, 0.4);
          transform: translateY(-2px);
        }

        #rematch-btn:active:not(:disabled) {
          transform: translateY(0);
          box-shadow: 0 0 15px rgba(255, 145, 0, 0.2);
        }

        #rematch-btn:disabled {
          border-color: #666;
          color: #666;
          background: linear-gradient(135deg, rgba(100, 100, 100, 0.1), rgba(100, 100, 100, 0.05));
          box-shadow: 0 0 10px rgba(100, 100, 100, 0.1);
          cursor: not-allowed;
          opacity: 0.7;
        }

        @keyframes buttonPulse {
          0%, 100% { box-shadow: 0 0 15px rgba(255, 166, 0, 0.2); }
          50% { box-shadow: 0 0 30px rgba(255, 187, 0, 0.5); }
        }

        #rematch-btn:not(:disabled) {
          animation: buttonPulse 2s ease infinite;
        }

        #back-btn {
            margin-top: 30px;
            padding: 10px 20px;
            font-size: 0.9rem;
            border: 1px solid #45b6fe;
            background: transparent;
            color: #45b6fe;
            box-shadow: 0 0 15px rgba(64, 180, 255, 0.2);
            cursor: pointer;
            transition: all 0.2s;
        }

        #back-btn:hover {
            border-color: #666;
            color: #fff;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            animation: confetti-fall 3s linear forwards;
        }

        #countdown-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 11000;
            pointer-events: auto;
            background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(2,3,5,0.55));
            backdrop-filter: blur(8px) saturate(140%);
            opacity: 0;
            transition: opacity 200ms ease;
        }

        #countdown-overlay:not(.hidden) { opacity: 1; }

        #countdown-number {
            font-size: 72px;
            font-weight: 900;
            color: #fff;
            letter-spacing: 6px;
            transform-origin: center center;
            will-change: transform, filter, opacity;
            display: inline-block;
            padding: 12px 20px;
            border-radius: 12px;
            position: relative;
            line-height: 1;
        }

    
        #countdown-number::after {
            content: '';
            position: absolute;
            inset: -14px;
            border-radius: 20px;
            background: radial-gradient(closest-side, rgba(255,150,40,0.06), rgba(255,80,0,0.02));
            box-shadow: 0 6px 30px rgba(255,120,20,0.08), 0 0 60px rgba(255,90,10,0.04);
            z-index: -1;
            filter: none;
            opacity: 0.85;
        }

        @keyframes neon-pop {
            0% { transform: perspective(400px) rotateX(60deg) scale(0.6); opacity: 0; filter: blur(1px); }
            45% { transform: perspective(400px) rotateX(0deg) scale(1.12); opacity: 1; filter: blur(0); }
            100% { transform: perspective(400px) rotateX(0deg) scale(1); opacity: 1; filter: drop-shadow(0 0 12px rgba(255,120,10,0.18)); }
        }

        .neon-pop {
            animation: neon-pop 320ms cubic-bezier(.18,.9,.3,1) both;
            text-shadow: 0 0 22px rgba(255,140,20,0.22), 0 0 44px rgba(255,90,20,0.08);
        }

        #countdown-number {
            -webkit-font-smoothing: subpixel-antialiased;
            text-rendering: optimizeLegibility;
            transform: translateZ(0);
        }

        
        #countdown-overlay:not(.hidden) #countdown-number {
            animation: none;
        }

        
        #countdown-number { position: relative; width: 1ch; height: 1em; }
        #countdown-number .prev, #countdown-number .next {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
            font-size: inherit; font-weight: inherit; letter-spacing: inherit; color: #fff;
            transition: color 180ms ease, text-shadow 180ms ease, transform 180ms ease, opacity 180ms ease;
        }
        #countdown-number .next { opacity: 0; transform: translateY(8px); }

        #countdown-number.swipe-anim::before {
            content: '';
            position: absolute;
            left: -10%; top: -6%; bottom: -6%; width: 0%;
            background: linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(2,3,5,0.9) 45%, rgba(0,0,0,0) 100%);
            z-index: 5;
            border-radius: 10px;
            animation: swipe 360ms cubic-bezier(.2,.9,.3,1) forwards;
        }

        @keyframes swipe {
            0% { left: -10%; width: 0%; }
            45% { left: 0%; width: 100%; }
            100% { left: 110%; width: 0%; }
        }

        #countdown-number.swipe-anim .prev { animation: prevFade 360ms cubic-bezier(.2,.9,.3,1) both; }
        #countdown-number.swipe-anim .next { animation: nextShow 360ms cubic-bezier(.2,.9,.3,1) both; animation-delay: 140ms; }

        @keyframes prevFade { 0% { opacity: 1; transform: translateY(0); } 45% { opacity: 0; transform: translateY(-8px); } 100% { opacity: 0; transform: translateY(-8px); } }
        @keyframes nextShow { 0% { opacity: 0; transform: translateY(8px); } 45% { opacity: 0; transform: translateY(8px); } 100% { opacity: 1; transform: translateY(0); } }

        #countdown-number .digit-3 {
            color: #ff9a00;
            text-shadow: 0 0 12px rgba(255,150,40,0.12);
        }
        #countdown-number .digit-2 {
            color: #ff3333;
            text-shadow: 0 0 12px rgba(255,60,60,0.10);
        }
        #countdown-number .digit-1 {
            color: #2ea8ff;
            text-shadow: 0 0 12px rgba(60,160,255,0.08);
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>BlitzTacToe</h1>
        <div id="countdown-overlay" class="hidden">
            <div id="countdown-number">3</div>
        </div>
        <div id="status">Connecting...</div>
        <div id="timer">--</div>
        <div class="info">
            <div>
                <div>You are</div>
                <div id="your-symbol">-</div>
            </div>
            <div>
                <div>Current turn</div>
                <div id="current-turn">-</div>
            </div>
        </div>
        <div class="board" id="board"></div>
        <div id="game-over-actions" class="hidden">
            <button id="rematch-btn">Rematch</button>
        </div>
        <button id="back-btn">back to lobby</button>
        <div id="toast" class="hidden"></div>
    </div>

    <script>
        let socket = null;
        let mySymbol = null;
        let currentTurn = null;
        let board = ["", "", "", "", "", "", "", "", ""];
        let gameOver = false;
        let gameStarted = false;
        let turnStarted = null;
        let turnTime = 5;
        let countdownInterval = null;
        let matchCountdownInterval = null;
        let matchVisibilityHandler = null;

        const statusEl = document.getElementById("status");
        const timerEl = document.getElementById("timer");
        const yourSymbolEl = document.getElementById("your-symbol");
        const currentTurnEl = document.getElementById("current-turn");
        const boardEl = document.getElementById("board");
        const gameOverActions = document.getElementById("game-over-actions");
        const rematchBtn = document.getElementById("rematch-btn");
        const backBtn = document.getElementById("back-btn");
        const toastEl = document.getElementById("toast");

        function init() {
            createBoard();
            connectWebSocket();
            rematchBtn.addEventListener("click", requestRematch);
            backBtn.addEventListener("click", () => {
                if(socket) {
                    socket.close();
                }
                window.location.href = "/";
            });
        }

        function createBoard() {
            boardEl.innerHTML = "";
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement("div");
                cell.className = "cell";
                cell.dataset.index = i;
                cell.addEventListener("click", () => handleCellClick(i));
                boardEl.appendChild(cell);
            }
        }

        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectBaseDelay = 2000;

        function connectWebSocket() {
            const roomId = window.location.pathname.split("/").filter(Boolean).pop();
            const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
            const wsUrl = `${protocol}//${window.location.host}/ws/game/${roomId}/`;

            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                setStatus("Connected. Waiting for opponent...");
                reconnectAttempts = 0;
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleServerMessage(data);
            };

            socket.onclose = (event) => {
                stopCountdown();
                stopMatchCountdown();
                
                if (event.code === 1000 || event.wasClean) {
                    setStatus("Disconnected.");
                    return;
                }
                
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    const delay = reconnectBaseDelay * Math.pow(1.5, reconnectAttempts - 1);
                    setStatus(`Connection lost. Reconnecting in ${Math.ceil(delay/1000)}s... (${reconnectAttempts}/${maxReconnectAttempts})`);
                    setTimeout(connectWebSocket, delay);
                } else {
                    setStatus("Connection lost. Please refresh the page.");
                }
            };

            socket.onerror = (error) => {
                console.error("WebSocket error:", error);
            };
        }

        function handleServerMessage(data) {
            switch (data.type) {
                case "error":
                    showToast("‚ùå " + (data.message || "An error occurred"));
                    break;
                case "countdown_start": handleCountdownStart(data); break;
                case "init": handleInit(data); break;
                case "game_start": handleGameStart(data); break;
                case "turn_change": handleTurnChange(data); break;
                case "turn_timeout": handleTurnTimeout(data); break;
                case "game_over": handleGameOver(data); break;
                case "game_reset": handleGameReset(data); break;
                case "rematch_requested": handleRematchRequested(data); break;
                case "player_left": handlePlayerLeft(data); break;
                default:
                    console.warn("Unknown message type:", data.type);
            }
        }

        function handleInit(data) {
            mySymbol = data.symbol;
            board = data.board;
            currentTurn = data.turn;
            turnTime = data.turn_time;
            gameStarted = data.game_started;
            yourSymbolEl.textContent = mySymbol;
            renderBoard();

            console.log("init", {
                turn_time: data.turn_time,
                turn_started: data.turn_started,
                client_now: Date.now() / 1000
            });

            if (data.countdown_started) {
                handleCountdownStart({countdown_started: data.countdown_started, countdown_seconds: data.countdown_seconds || 3});
                setStatus("Get ready...");
            } else if (gameStarted && data.turn_started) {
                startCountdown(data.turn_started, turnTime);
                updateTurnDisplay();
            } else {
                setStatus("Waiting for opponent...");
            }
        }

        function handleGameStart(data) {
            gameStarted = true;
            gameOver = false;
            currentTurn = data.turn;
            turnTime = data.turn_time;

            console.log("game_start", {
                turn_time: data.turn_time,
                turn_started: data.turn_started,
                client_now: Date.now() / 1000
            });

            updateTurnDisplay();

            stopMatchCountdown();
            startCountdown(data.turn_started, turnTime);
            boardEl.classList.add('active');
            showToast("Game started!");
        }

        function handleCountdownStart(data) {
            const started = data.countdown_started;
            const seconds = data.countdown_seconds || 3;
            startMatchCountdown(started, seconds);
        }

        function startMatchCountdown(serverStartedAt, seconds) {
            stopMatchCountdown();
            if(!serverStartedAt) return;

            const overlay = document.getElementById('countdown-overlay');
            const numberEl = document.getElementById('countdown-number');
            overlay.classList.remove('hidden');
            overlay.style.pointerEvents = 'auto';

            numberEl.innerHTML = '<span class="prev"></span><span class="next"></span>';
            const prevEl = numberEl.querySelector('.prev');
            const nextEl = numberEl.querySelector('.next');

            const startMs = serverStartedAt * 1000;
            let prevRemaining = null;

            function setDigitClass(el, val, delay = 80) {
                if (!el) return;
                el.classList.remove('digit-1','digit-2','digit-3');
                el.style.color = '#fff';
                const apply = () => {
                    if (val === 1 || val === '1') el.classList.add('digit-1');
                    else if (val === 2 || val === '2') el.classList.add('digit-2');
                    else if (val === 3 || val === '3') el.classList.add('digit-3');
                    el.style.color = '';
                };
                if (!delay) apply(); else setTimeout(apply, delay);
            }
            function update() {
                const elapsed = (Date.now() - startMs) / 1000;
                const remaining = Math.max(0, Math.ceil(seconds - elapsed));
                if (prevRemaining === null) {
                    prevEl.textContent = remaining;
                    setDigitClass(prevEl, remaining);
                    prevEl.classList.remove('neon-pop');
                    void prevEl.offsetWidth;
                    prevEl.classList.add('neon-pop');
                    prevRemaining = remaining;
                } else if (remaining !== prevRemaining) {
                    prevEl.textContent = prevRemaining;
                    setDigitClass(prevEl, prevRemaining);
                    nextEl.textContent = remaining;
                    setDigitClass(nextEl, remaining, 0);
                    numberEl.classList.remove('swipe-anim');
                    void numberEl.offsetWidth;
                    numberEl.classList.add('swipe-anim');
                    const collapseDelay = (remaining === 1) ? 900 : 420;
                    setTimeout(() => {
                        numberEl.classList.remove('swipe-anim');
                        prevEl.textContent = remaining;
                        setDigitClass(prevEl, remaining);
                        nextEl.textContent = '';
                        nextEl.classList.remove('digit-1','digit-2','digit-3');
                    }, collapseDelay);
                    prevRemaining = remaining;
                }
                if (remaining <= 0) {
                    setTimeout(() => {
                        stopMatchCountdown();
                    }, 700);
                }
            }

            update();
            matchCountdownInterval = setInterval(update, 250);

            matchVisibilityHandler = () => update();
            document.addEventListener('visibilitychange', matchVisibilityHandler);
        }

        function stopMatchCountdown() {
            const overlay = document.getElementById('countdown-overlay');
            if (matchCountdownInterval) {
                clearInterval(matchCountdownInterval);
                matchCountdownInterval = null;
            }
            if (matchVisibilityHandler) {
                document.removeEventListener('visibilitychange', matchVisibilityHandler);
                matchVisibilityHandler = null;
            }
            if (overlay) overlay.classList.add('hidden');
        }

        function handleTurnChange(data) {
            board = data.board;
            currentTurn = data.turn;
            renderBoard();
            updateTurnDisplay();
            if (data.countdown_started) {
                handleCountdownStart({countdown_started: data.countdown_started, countdown_seconds: data.countdown_seconds});
            } else {
                startCountdown(data.turn_started, data.turn_time);
            }
        }

        function handleTurnTimeout(data) {
            board = data.board;
            currentTurn = data.turn;
            renderBoard();
            updateTurnDisplay();
            startCountdown(data.turn_started, data.turn_time);
            showToast("turn skipped (timeout)!");
        }

        function launchConfetti()
        {
            const colors = ['#ff4444', '#ffaa00', '#00ff64', '#00aaff', '#f5a927'];
            for(let i = 0; i < 50; i++)
            {

                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';

                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                    document.body.appendChild(confetti);

                    setTimeout(() => {
                        confetti.remove();
                    }, 4000);
                }, i * 100);

            }
        }

        function handleGameOver(data) {
            gameOver = true;
            board = data.board;
            stopCountdown();
            renderBoard();

            if (data.winner === "draw") {

                setStatus("it's a draw! again!!!");
                statusEl.className = "draw";
                boardEl.classList.add('slide-off');
                return;

              } else if (data.winner === mySymbol) {

                setStatus("you win!!!!");
                if(data.forfeit)
                    statusEl.textContent += " (opponent disconnected)";
                statusEl.className = "win";
                launchConfetti();

              } else {

                setStatus("you lose....");
                statusEl.className = "lose";
                document.querySelector('.container').classList.add('shake');

              }

            highlightWinner(data.winner);

            if(data.winner !== "draw")
            {
              const cells = boardEl.querySelectorAll(".cell");
              cells.forEach(cell => {
                  if (cell.dataset.winning === "true") {
                    cell.dataset.result = (data.winner == mySymbol) ? "win" : "lose";
                  }
                
              });
            }

            if(!data.forfeit)
            {
                gameOverActions.classList.remove("hidden");
                rematchBtn.disabled = false;
                rematchBtn.textContent = "Rematch";
            }
            timerEl.textContent = "--";
        }

        function handleGameReset(data) {

          if(boardEl.classList.contains('slide-off')) {
            boardEl.classList.remove('slide-off');
            boardEl.classList.add('slide-in');
            setTimeout(() => {
              boardEl.classList.remove('slide-in');
            }, 400);
          }

            document.querySelector('.container').classList.remove('shake');
            statusEl.className = "";
            board = data.board;
            currentTurn = data.turn;
            gameOver = false;

            const cells = boardEl.querySelectorAll(".cell");
            cells.forEach(cell => {
              cell.dataset.winning = "";
              cell.dataset.result = "";
            });

            renderBoard();
            updateTurnDisplay();
            startCountdown(data.turn_started, data.turn_time);
            gameOverActions.classList.add("hidden");
            showToast("new game started!");
        }

        function handleRematchRequested(data) {
            if (data.symbol !== mySymbol) {
                showToast(`${data.symbol} wants a rematch!`);
            }
        }

        function handlePlayerLeft(data) {
            gameStarted = false;
            stopCountdown();
            setStatus(`Player ${data.symbol} left. waiting for new opponent...`);
            timerEl.textContent = "--";
        }

        function handleCellClick(index) {
            if (!gameStarted) return;
            if (gameOver) return;
            if (currentTurn !== mySymbol) return;
            if (board[index] !== "") return;
            socket.send(JSON.stringify({ index: index }));
        }

        function requestRematch() {
            socket.send(JSON.stringify({ action: "rematch" }));
            rematchBtn.disabled = true;
            rematchBtn.textContent = "waiting...";
            showToast("rematch requested!");
        }

        function startCountdown(serverTurnStarted, serverTurnTime) {
            stopCountdown();

            console.log("startCountdown called", {
                serverTurnStarted,
                serverTurnTime,
                turnTime_var: turnTime,
                client_now: Date.now() / 1000
            });

            if (!serverTurnStarted || !serverTurnTime) {
                timerEl.textContent = "--";
                return;
            }

            const startedAt = (serverTurnStarted * 1000) || Date.now();

            turnTime = serverTurnTime;

            function updateTimer() {
                const elapsed = (Date.now() - startedAt) / 1000;
                const remainingPrecise = Math.max(0, turnTime - elapsed);

                const display = remainingPrecise.toFixed(2);

                timerEl.textContent = display;
                timerEl.dataset.remaining = Math.ceil(remainingPrecise);

                if (remainingPrecise <= 0) {
                    stopCountdown();
                }
            }

            updateTimer();
            countdownInterval = setInterval(updateTimer, 20);
        }

        function stopCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        function renderBoard() {
            const cells = boardEl.querySelectorAll(".cell");
            cells.forEach((cell, i) => {
                cell.textContent = board[i];
                cell.dataset.symbol = board[i].toLowerCase();
            });
        }

        function updateTurnDisplay() {
            currentTurnEl.textContent = currentTurn;
            if (currentTurn === mySymbol) {
                setStatus("Your turn!");
            } else {
                setStatus("Opponent's turn...");
            }
        }

        function setStatus(message) {
            statusEl.textContent = message;
        }

        function highlightWinner(winner) {
            if (winner === "draw") return;

            const wins = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];

            const cells = boardEl.querySelectorAll(".cell");
            for (const [a, b, c] of wins) {
                if (board[a] && board[a] === board[b] && board[b] === board[c]) {
                    cells[a].dataset.winning = "true";
                    cells[b].dataset.winning = "true";
                    cells[c].dataset.winning = "true";
                    break;
                }
            }
        }

        function showToast(message) {
            toastEl.textContent = message;
            toastEl.classList.remove("hidden");
            setTimeout(() => toastEl.classList.add("hidden"), 2500);
        }

        document.addEventListener("DOMContentLoaded", init);
    </script>
</body>
</html> 